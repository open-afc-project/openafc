# check .env file for env vars info and values

version: '3.2'
services:
  ratdb:
    image: postgres:9
    restart: always
    environment:
      - POSTGRES_PASSWORD=N3SF0LVKJx1RAhFGx4fcw
      - PGDATA=/var/lib/pgsql/data
      - POSTGRES_DB=fbrat

  rmq:
    image: public.ecr.aws/w9v6y1o0/openafc/rmq-image:${TAG:?err}
    restart: always

  nginx:
    image: public.ecr.aws/w9v6y1o0/openafc/ngnx-image:${TAG:?err}
    restart: always
    ports:
      - "${EXT_IP}:${EXT_MTLS_PORT}:443"
    volumes:
      - ${VOL_H_NGNX:-/tmp}:${VOL_C_NGNX:-/dummyngnx}
    environment:
      - AFC_MSGHND_NAME=msghnd
      - AFC_MSGHND_PORT=8000

  rat_server:
    image: 110738915961.dkr.ecr.us-east-1.amazonaws.com/afc-server:${TAG:?err}
    ports:
      - "${EXT_IP}:${EXT_PORT}:80"
      - "${EXT_IP}:${EXT_PORT_S}:443"
    volumes:
      - ${VOL_H_DB}:${VOL_C_DB}
      - ${VOL_H_SSL:-/tmp}:${VOL_C_SSL:-/dummy1}
      - ${VOL_H_APACH:-/tmp}:${VOL_C_APACH:-/dummy2}

      - ./afc_config:/var/lib/fbrat/afc_config
      - ./pipe:/pipe
    depends_on:
      - ratdb
      - rmq
      - objst
    environment:
      # RabbitMQ server name:
      - BROKER_TYPE=external
      - BROKER_FQDN=rmq
      # Filestorage params:
      - AFC_OBJST_HOST=objst
      - AFC_OBJST_PORT=5000
      - AFC_OBJST_SCHEME=HTTP
      - AFC_OBJST_HIST_HOST=objst
      # worker params
      - CELERY_TYPE=external

  msghnd:
    image: 110738915961.dkr.ecr.us-east-1.amazonaws.com/afc-msghnd:${TAG:?err}
    environment:
      # RabbitMQ server name:
      - BROKER_TYPE=external
      - BROKER_FQDN=rmq
      # Filestorage params:
      - AFC_OBJST_HOST=objst
      - AFC_OBJST_PORT=5000
      - AFC_OBJST_SCHEME=HTTP
      - AFC_OBJST_HIST_HOST=objst
    depends_on:
      - ratdb
      - rmq
      - objst
      - nginx

  objst:
    image: public.ecr.aws/w9v6y1o0/openafc/objstorage-image:${TAG:?err}
    environment:
      - AFC_OBJST_HOST=0.0.0.0
      - AFC_OBJST_PORT=5000
      - AFC_OBJST_HIST_HOST=0.0.0.0
      - AFC_OBJST_HIST_PORT=4999
      - AFC_OBJST_LOCAL_DIR=/storage
  worker:
    image: 110738915961.dkr.ecr.us-east-1.amazonaws.com/afc-worker:${TAG:?err}
    volumes:
      - ${VOL_H_DB}:${VOL_C_DB}
    environment:
      # Filestorage params:
      - AFC_OBJST_HOST=objst
      - AFC_OBJST_PORT=5000
      - AFC_OBJST_SCHEME=HTTP
      # worker params
      - CELERY_OPTIONS=rat_1 rat_2 rat_3 rat_4 rat_5 rat_6 rat_7 rat_8 rat_9 rat_10 rat_11 rat_12 rat_13 rat_14 rat_15
      # RabbitMQ server name:
      - BROKER_TYPE=external
      - BROKER_FQDN=rmq
    depends_on:
      - ratdb
      - rmq
      - objst
