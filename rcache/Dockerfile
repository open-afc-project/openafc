#
# Copyright (C) 2023 Broadcom. All rights reserved. The term "Broadcom"
# refers solely to the Broadcom Inc. corporate affiliate that owns
# the software below. This work is licensed under the OpenAFC Project License,
# a copy of which is included with this software program
#

FROM python:3.12-alpine3.21

# True if enabled (default is True)
# ENV RCACHE_ENABLED=True

# Port REST API service listen on
# ENV RCACHE_CLIENT_PORT

# REST API URL that performs database creation
ENV AFC_DB_CREATOR_URL=http://rat_server/fbrat/admin/CreateDb

# Connection string to Postgres DB
# ENV RCACHE_POSTGRES_DSN=postgresql://[user[:password]@]host[:port]/database[?options]

# File with password for Rcache database DSN
# ENV RCACHE_POSTGRES_PASSWORD_FILE

# Maximum number of simultaneous precomputation requests. Default is 10
ENV RCACHE_PRECOMPUTE_QUOTA=10

# REST API URL to send precompute requests to. No precomputation if absent
# ENV RCACHE_AFC_REQ_URL

# REST API URL for requesting list of active AFC Configs. Default max link
# distance (130km) is used for spatial invalidation if unspecified or not
# responding
# ENV RCACHE_RULESETS_URL

# REST API URL to use for requesting AFC Config by Ruleset ID. Default max link
# distance (130km) is used for spatial invalidation if unspecified or not
# responding
# ENV RCACHE_CONFIG_RETRIEVAL_URL

# Additional command line parameters for uvicorn
ENV RCACHE_UVICORN_PARAMS="--no-access-log --log-level info"

# Keyhole shape definition template file, generated by keyhole_gen.py
# from KeyHoleShape analysis result
ENV RCACHE_KEYHOLE_TEMPLATE=/wd/keyhole_postgis.template


# Alembic parameters
ENV RCACHE_ALEMBIC_CONFIG=/wd/migrations/alembic.ini

# Initial Alembic version (used to stamp existing alembicless database)
ENV RCACHE_ALEMBIC_INITIAL_VERSION=5663cf8afbd7

# Current Alembic version (used to stamp newly created database). Default is
# 'head'
# ENV RCACHE_ALEMBIC_HEAD_VERSION

RUN apk add --update --no-cache curl

WORKDIR /wd

# Configure pip to use package registry proxy (optional)
ARG PIP_INDEX_URL
ENV PIP_INDEX_URL=${PIP_INDEX_URL}

# Installing Python libraries
#   Version of librdkafka-dev depends on Alpine version. confluent-kafka
#   version in requirements.txt may need to be updated on Alpine version change
RUN apk add --update --no-cache librdkafka-dev
COPY rcache/requirements.txt /wd
RUN apk add --update --no-cache python3-dev build-base && \
    pip3 install --root-user-action=ignore  --no-cache-dir -r /wd/requirements.txt && \
    apk del --purge python3-dev build-base && rm -f /wd/requirements.txt

COPY src/afc-packages /wd/afc-packages
RUN pip3 install --use-pep517 --root-user-action=ignore \
        -r /wd/afc-packages/pkgs.rcache \
    && rm -rf /wd/afc-packages

COPY rcache/rcache_app.py rcache/rcache_app.py rcache/rcache_db_async.py \
    rcache/rcache_service.py tools/rcache/rcache_tool.py \
    tools/keyhole/keyhole_gen.py tools/keyhole/keyhole_postgis.template /wd/
RUN chmod a+x /wd/rcache_tool.py /wd/keyhole_gen.py
COPY rcache/migrations /wd/migrations

ENTRYPOINT uvicorn rcache_app:app --host 0.0.0.0 --port ${RCACHE_CLIENT_PORT} \
    ${RCACHE_UVICORN_PARAMS}

HEALTHCHECK --start-period=20s \
    CMD curl -f http://localhost:${RCACHE_CLIENT_PORT}/healthcheck || exit 1