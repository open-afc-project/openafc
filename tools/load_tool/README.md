Copyright (C) 2022 Broadcom. All rights reserved.\
The term "Broadcom" refers solely to the Broadcom Inc. corporate affiliate that
owns the software below. This work is licensed under the OpenAFC Project
License, a copy of which is included with this software program.

# `afc_load_tool.py` - script for AFC load test

## Table of contents
 - [Overview](#overview)
 - [Requests, messages](#requests)
 - [Prerequisites](#prerequisites)
 - [Config file](#config)
 - [`afc_load_tool.py`](#tool)
   - [`preload` subcommand](#preload)
   - [`load` subcommand](#load)
 - [Usage example](#examples)

## Overview <a name="overview"/>

`afc_load_tool.py` is a script that sends AFC Requests to AFC Server in several parallel streams. It was designed to be used standalone.

Several instances of this script can be used simultaneously (e.g. from different locations), however this script does not (yet?) contain means for orchestration and statistics aggregation of this use case.

The major AFC performance bottleneck is AFC computations, so in order to avoid test results to be determined by this slowest component, this script has an ability to **preload** response cache with (fake) results so that subsequent load test would use these fake results and not be constrained by AFC computations' performance.

## Requests, messages <a name="requests"/>

It is important to distinguish **AFC Request Message** from **AFC Request**

**AFC Request Message** is a message sent to AFC Server. It may contain several **AFC Requests** - more than one if sent from, say, AFC Aggregator. `afc_load_tool.py` supports putting more than one request to message (by means of **`--batch`** command line parameter).

Each AFC Request, generated by `afc_load_tool.py`, has AP coordinates and Serial Number determined by **Request Index** (an integer value). Thus it is important for set of Request Indices (**`--idx_range`** command line parameter) used during load test to be the same (or be a subset of) set of Request Indices used during preload.

## Prerequisites <a name="prerequisites"/>

`afc_load_tool.py` is a Python 3 script. Successfully tried on Python **3.7** (more is better, as always).

Its only nonstandard dependency is **yaml** module, that can be installed with **`pip install pyyaml`** (even on Alpine) - and is typically present on each Python 3 installation even though it is not officially standard.

## Config file <a name="config"/>

Some important constants used by script are stored outside, in config file. This is YAML file, by default having same name and location as script (except that it has *.yaml* extension).

File content is, hopefully, self-descriptive, so here is just a brief overview of its sections.

|Section|Content|
|-------|-------|
|defaults|Default values for performance-related script parameters (index range, number of repetitions, etc. - see commends in config file and script help message)|
|region|Region for which requests will be generated: rectangle, grid density, Ruleset ID (AFC's regulatory domain identifier), Certification ID (AFC's manufacturer identifier - must be registered in RAT DB for used Ruleset ID)|
|req_msg_pattern|AFC Request Message pattern|
|resp_msg_pattern|AFC Response Message pattern|
|paths|Points of modifications in Request/Response Message patterns|
|channels_20mhz|List of 20MHz channels, used to make preload AFC Responses unique|
|rest_api|(Semi)default URLs for REST APIs used by script|

It is possible to use several merged together config files - e.g. have one full config file and several config files with default and/or regional parameters.

## `afc_load_tool.py` <a name="tool"/>

General invocation format:

`afc_load_tool.py [--config [+]FILENAME.yaml] ... load|preload [PARAMETERS]`

`--config` may be specified several times or not at all (in which case default one will be used). If config filename prefixed with `+`, it is used as an addition (not instead of) the default config. E.g.  
`afc_load_tool.py --config +brazil.yaml] ... preload`  
might be used when *brazil.yaml* defines `region` section for Brazil, whereas the rest of config data comes from default config file.

Without parameters script prints list of subcommands. Help on specific subcommand may be printed by means of `help` subcommand. E.g. help for `preload` subcommand may be printed as follows:  
`afc_load_tool.py help preload`  
Note that due to Python idiosyncrasies, `--help` will only print help on `--config` parameter.

### `preload` subcommand <a name="preload"/>

Preloads rcache with fake responses for given range of request indices.

Parameters:

|Parameter|Default<br>in Config|Meaning|
|---------|--------------------|-------|
|--idx_range **FROM**-**TO**|0-1000000|Range of request indices to preload to cache. Note that *TO* is 'afterlast' index, i.e. 0-1000000 means [0-999999]|
|--parallel **N**|20|Number of parallel streams (may speed up operation and entertaining in general)|
|--batch **N**|1|Number of requests per message (may speed up operation and entertaining in general)|
|--backoff **SEC**|0.1|Initial backoff (in seconds) if request failed. Useful in wrestling with DDOS protection|
|--retries **N**|5|Number of retries to make if request fails. Useful in wrestling with DDOS protection|
|--status_period **N**|1000|Once in what number of requests to print intermediate statistics. 0 to not at all|
|--dry||Don't actually send anything to servers. Useful to determine overhead of this script itself|
|--comp_proj **PROJ**||Docker Compose project name (part before service name in container names) to use to determine IPs of services being used (*rat_server* and *rcache* for this subcommand)|
|--rat_server **HOST[:PORT]**|rat_server|IP Address (and port, if not 80) of rat_server service (yes, this subcommand needs access to the guts of AFC)|
|--rcache **HOST:PORT**|rcache:8000|IP Address (and port, if not 80) of rcache service (yes, this subcommand needs access to the guts of AFC)|

### `load` subcommand <a name="load"/>

Do the load test.

Parameters:

|Parameter|Default<br>in Config|Meaning|
|---------|--------------------|-------|
|--idx_range **FROM**-**TO**|0-1000000|Range of request indices to use (supposedly they have been preloaded to rcache with *preload* subcommand). Note that *TO* is 'afterlast' index, i.e. 0-1000000 means [0-999999]|
|--count **N**|1000000|Number of requests to send|
|--parallel **N**|20|Number of parallel streams|
|--batch **N**|1|Number of requests per message|
|--backoff **SEC**|0.1|Initial backoff (in seconds) if request failed. Useful in wrestling with DDOS protection|
|--retries **N**|5|Number of retries to make if request fails. Useful in wrestling with DDOS protection|
|--status_period **N**|1000|Once in what number of requests to print intermediate statistics. 0 to not at all|
|--dry||Don't actually send anything to servers. Useful to determine overhead of this script itself|
|--comp_proj **PROJ**||Docker Compose project name (part before service name in container names) to use to determine IPs of services being used (*msghnd* for this subcommand)|
|--afc **HOST[:PORT]**|msghnd:8000|IP Address (and port, if not 80) to send AFC Requests to. If neither it not --localhost specified, requests will be sent to msghnd, determined by means of --comp_proj|
|--localhost [http|https]||Send AFC requests to AFC http(default) or https port of AFC, running on localhost with project, specified by --comp_proj|


## Usage example <a name="examples"/>

```
$ docker ps
CONTAINER ID   IMAGE        ...        PORTS                                                                              NAMES
...
acffe87ff12c   public.ecr.aw...        0.0.0.0:374->80/tcp, :::374->80/tcp, 0.0.0.0:458->443/tcp, :::452->443/tcp         fs936724_l2_dispatcher_1
bce6e9629ef1   110738915961....        80/tcp, 443/tcp                                                                    fs936724_l2_rat_server_1
7f76bdee65d8   110738915961....        8000/tcp                                                                           fs936724_l2_msghnd_1
152dd3a42ce7   110738915961....                                                                                           fs936724_l2_worker_1
d102db21067d   public.ecr.aw...                                                                                           fs936724_l2_cert_db_1
987115a71c95   public.ecr.aw...                                                                                           fs936724_l2_als_siphon_1
08e1ec3248d2   public.ecr.aw...                                                                                           fs936724_l2_rcache_1
803e9b266310   public.ecr.aw...        5432/tcp                                                                           fs936724_l2_ratdb_1
7ba8ce112cae   public.ecr.aw...        5432/tcp                                                                           fs936724_l2_bulk_postgres_1
92fd56d4db75   public.ecr.aw...                                                                                           fs936724_l2_objst_1
a5c680bb32b6   rcache_tool:f...                                                                                           fs936724_l2_rcache_tool_1
871849a6e841   public.ecr.aw...        9092/tcp                                                                           fs936724_l2_als_kafka_1
efea7249498f   public.ecr.aw...                                                                                           fs936724_l2_uls_downloader_1
b3903f7c2d92   public.ecr.aw...        4369/tcp, 5671-5672/tcp, 15691-15692/tcp, 25672/tcp                                fs936724_l2_rmq_1
...
```

Three important pieces of information should be derived from this printout:
- **Docker compose project name** - common prefix of container names: *fs936724_l2*
- **External AFC port** - external port of *dispatcher* container, mapped to internal port 80: *374*
- **Rcache container name**: *fs936724_l2_rcache_1*

Now, before starting cache preload it is recommended to disable rcache invalidation (that might be caused by ULS downloader). This may be done by means of `rcache_tool.py` in *rcache* container:  
`$ docker exec fs936724_l2_rcache_tool_1 /wd/rcache_tool.py invalidate --disable`  
In this command rcache container name was used

Now, preloading rcache, using default parameters from config file:  
`$ afc_load_tool.py preload --comp_proj fs936724_l2`  
In this command compose project name was used.

Now, doing load test with default parameters from config file (USA, 20 streams, one request per message, status every 1000 requests, send one million requests, etc.):
  - Send AFC requests to HTTP port of AFC server on current host:  
    `$ afc_load_tool.py load --comp_proj fs936724_l2 --localhost`
  - Send AFC requests to *msghnd* service (bypassing *dispatcher* service):  
    `$ afc_load_tool.py load --comp_proj fs936724_l2`
  - Send AFC requests to explicitly specified server (still - local host in this case):  
    `$ afc_load_tool.py load --afc localhost:374`  
    In this case external AFC port (see `docker ps` output above) was used.

Upon completion of testing it is recommended to re-enable cache invalidation:  
`$ docker exec fs936724_l2_rcache_tool_1 /wd/rcache_tool.py invalidate --enable`  
