Copyright (C) 2022 Broadcom. All rights reserved.\
The term "Broadcom" refers solely to the Broadcom Inc. corporate affiliate that
owns the software below. This work is licensed under the OpenAFC Project
License, a copy of which is included with this software program.

# Keyhole shape conversion tool

## Table of contents

- [Keyhole shape](#keyhole_shape)
- [Measuring keyhole shape](#measuring)
- [Prerequisites](#prerequisites)
- [Usage](#usage)
- [Precomputed keyhole](#precomputed)

## Keyhole shape <a name="keyhole_shape">

**Keyhole shape** is a shape around FS RX/PR antenna that covers all SP AP locations that potentially may affect it. It is elongated in the direction of antenna beam.

It got its name from the (incorrect) a-priory idea that it will have resemble a keyhole. In reality it doesn't resemble anything at all.

Keyhole shape has two uses:

- Determine which Response Cache entries to invalidate when FS changes (those entries that covered by keyhole shapes of FS RX/PR antennas added/removed)
- Determine which SP AP might have interfere a particular FS RX. This criteria is rather broad, but still much better than search through all SP APs in 150 miles from affected FS RX (circle of this radius covers New York, Philadelphia and Washington DC).

## Measuring keyhole shape <a name="measuring">

Each antenna model has its own keyhole shape (that corresponds to its antenna diagram), but dealing with individual keyhole shapes is logistically too complicated. So OpenAFC currently uses a single keyhole shape purported to contain all possible keyhole shapes - thus, definitely, losing some efficiency (maybe this will be improved in the future).

No good analytical or normative way to compute keyhole shape were found (so far) - even for single antenna model. Thus it was measured like this:

1. For each FS RX and PR antenna in representative FS database keyhole shape is computed by assuming SP AP uses maximum power, signal propagation is free space (no terrain - which brings typically more than 20dB margin), Frequencies are in U-NII-5/6/7/8 ranges.  
   At the moment of this writing this database contains all US and Canada FSs (total of 114000 FSs).
2. Resulting keyhole shape covers them all
3. It is 'unjagged' in outward direction.

Steps #1 and #2 are performed in `AFC Engine` by `KeyHoleShape` analysis. As of time of this writing this change to `AFC Engine` is not yet officially released, so no automation is applicable yet.

Step #3 (as well as conversion to database-query-compatible format) is performed by `keyhole_gen.py` script, described in this document.

## Prerequisites <a name="prerequisites">

`keyhole_gen.py` is a Python 3 script that uses `shapely` and `matplotlib` libraries. It might be run from container (use provided `Dockerfile`), but making it show keyhole shape in this case is complicated (albeit solvable) task not addressed here - thus running it natively (maybe with `virtualenv`) is recommended.

`keyhole_gen.py` as an input uses JSON file, generated by `KeyHoleShape` analysis of `AFC Engine`. This file has the following structure:
```
{
    "anglesDeg": [
        0,
        0.1,
        0.2,
....
        179.8,
        179.9,
        180
    ],
    "distancesM": [
        230000,
        230000,
        230000,
...
        9654,
        9654,
        9654
    ]
}
```

Here the first vector (`anglesDeg`) contains angles off boresight (between FS RX/PR antenna beam and direction to SP AP) in degrees, second vector (`distancesM`) contains matching distances (from FS RX antenna to the boundary of keyhole shape) in meters.


## Usage <a name="usage">

`keyhole_gen.py` has the following command line format:

`keyhole_gen.py [OPTIONS] INPUT_FILE [OUTPUT_FILE]`

Here:

- `INPUT_FILE` is JSON file, generated by `KeyHoleShape` analysis of `AFC Engine`, its structure was described earlier
- `OUTPUT_FILE` is shape file in some format (currently supported are `WKB` and `WKT` formats). If unspecified then only shape displaying is performed (if requested)
- `OPTIONS` are:

|Option|Meaning|
|------|--------|
|--simplify **METHOD**|How to improve original strangely-looked shape. `convhull` - use its convex hull, `unjag` - use an ad-hoc jag0filling algorithm. Default is leave original shape as is|
|--tolerance **METERS**|Tolerance in meters of vertex reduction. Default is 100|
|--show|Display resulting shape|
|--format **FORMAT**|Output file format. Currently `wkb`/`wkt` (Well Known Text / Binary respectively) and `sql` (PostGIS geography polygon with Jinja-style inserts for center point and rotation) are supported. Default is `sql`|


## Precomputed keyhole <a name="precomputed">

This folder contains `keyhole_postgis.template` shape file created  with the following command:

`keyhole_gen.py --simplify convhull --tolerance 100 --format sql keyhole.json keyhole.wkt`

Here `keyhole.json` is result of `KeyHoleShape` analysis computed from 2/12/2025 US/Canadian FS database. Analysis request JSON file was:

```
{
    "minFreqMhz": 5925,
    "maxFreqMhz": 7125,
    "aobStepDeg": 0.1,
    "freqStepMhz": 1000,
    "radiusKm": 230
}
```
As of time of this writing keyhole shape looks like this (raw is orange, resulting shape is within red border):
![keyhole shape](keyhole_us_ca_2-12-2025.png "Keyhole shape")

Shape is admittedly insanely wide, migth be improved in the future if more adequate antenna diagrams will be used in AFC Engine.
